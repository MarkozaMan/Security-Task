let uniqueid;$(function(){const e="_cells_";const t=`${e}customer_role`;let u;const f=5678;let m=[];let h=localStorage.getItem(t)==="2";const w=decodeURIComponent(F("FolderName"));const y=decodeURIComponent(F("FileName"));const g=decodeURIComponent(F("Password"));const n=o.CallbackURL;const b=o.APIBasePath;const a=decodeURIComponent(F("Uid"));const S=o.AppUrl;const i="https://www.googleapis.com/auth/drive.file";const s=o.GoogleDriveConfigurations.GoogleDriveClientId;let l;let r=null;let c=false;let d=false;if(L(w)||L(y)){T()}else{$("#file_name").text(y);C();$("#confirmClose").on("click",function(){$("#confirmCloseModal").modal({keyboard:true})});$("#confirmCloseModal").on("show.bs.modal",function(){$("#confirmCloseModal").css("display","flex")});p().then()}async function p(){$.getScript(`${o.JsPath}/bootstrap.min.${o.JsVersionSuffix}`);$.getScript(`${o.JsPath}/jszip.min.${o.JsVersionSuffix}`);$.getScript(`${o.JsPath}/pako.min.${o.JsVersionSuffix}`);$.getScript(`https://apis.google.com/js/api.js`,function(){O()});$.getScript(`https://accounts.google.com/gsi/client`,function(){P()})}function C(){const e=`${b}EditorApi/DetailStreamJsonWithUid`;AjaxHelper.authenticatedRequest({method:"POST",url:e,xhrFields:{withCredentials:true},crossDomain:true,data:JSON.stringify({file:y,folder:w,password:L(g)?"":g,uid:a,locale:o.Locale}),contentType:"application/json",cache:false,error:function(e){if(e!==undefined&&e.Status!==undefined){alert(e.Status);T();return}if(e.responseJSON!==undefined&&e.responseJSON.Status!==undefined){alert(e.responseJSON.Status);T();return}alert("Error");T()},success:function(e){if(e.Error){alert(e.Error);T()}else{$(".content-wrapper").css("background","none");E(e)}}})}function E(e){uniqueid=e.uniqueid;e.data.forEach(e=>{if(e.rows.len<50){e.rows.len=50}});m=e.data;const t=`${b}EditorApi/ImageUrl`;const n=`${b}EditorApi/UpdateCell`;const a=o.Locale==="zh-hant"?"cht":o.Locale;u=x_spreadsheet("#xs-div",{updateMode:"server",updateUrl:n,mode:"edit",folderName:w,fileName:y,local:a,showCheckSyntaxButton:h,checkSyntax:false,showFormulaExplain:h}).loadData(m).updateCellError(e=>{alert(e)});if(!e.showtabs){u.bottombar.hide()}const i=`${b}EditorApi/AddImage`;const s=`${b}EditorApi/AddImageByUrl`;const l=`${b}EditorApi/CopyImage`;u.setUniqueId(uniqueid);u.setImageInfo(t,i,s,l,f);u.setActiveSheetByName(e.actname).setActiveCell(e.actrow,e.actcol);$.fn.scrollEnd=function(t,o){$(this).scroll(function(){const e=$(this);if(e.data("scrollTimeout")){clearTimeout(e.data("scrollTimeout"))}e.data("scrollTimeout",setTimeout(t,o))})};const r=`${b}EditorApi/Download`;u.setFileDownloadInfo(r);u.setFileName(y);if(u.setEmailSendCallFunction){u.setEmailSendCallFunction(x)}if(u.setOpenFileUrl){u.setOpenFileUrl(S)}u.setFileDownloadCallFunction(v);const c=`${b}EditorApi/Ole`;u.setOleDownloadInfo(c);const d=`${b}EditorApi/CheckSyntax`;u.setSyntaxCheckUrl(d);const p=`${b}EditorApi/FormulaExplain`;u.setFormulaExplainUrl(p)}async function v(e,t,o){I();const n={p:{sheetname:u.sheet.data.name,actrow:u.sheet.data.selector.ri,actcol:u.sheet.data.selector.ci,datas:u.getUpdateDatas()},uid:uniqueid,file:y,folderName:w,outputType:t,password:g};const a=new FormData;a.append("p",JSON.stringify(n.p));a.append("uid",n.uid);a.append("file",n.file);a.append("folderName",n.folderName);a.append("outputType",n.outputType);a.append("password",n.password);try{if(o==="Device"){const i=await fetch(`${b}EditorApi/Download`,{method:"POST",body:a});if(!i.ok){throw new Error(`Download failed with status: ${i.status}`)}const s=await i.blob();D(s,e)}else{const i=await fetch(`${b}EditorApi/PrepareCloudSave`,{method:"POST",body:a});if(!i.ok){throw new Error(`Failed to prepare file for cloud save. Status: ${i.status}`)}const l=await i.json();const r=l.downloadUrl;if(!r){throw new Error("Could not get a valid file URL from the server.")}if(o==="GoogleDrive"){R(r,e)}else if(o==="Dropbox"){Dropbox.save(r,e,{success:function(){alert(`Successfully saved to Dropbox`)},error:function(){alert(`Failed to save to Dropbox`)}})}}}catch(e){console.error("Save operation failed:",e);alert("Save operation failed. Please try again.")}finally{N()}}async function x(e){const t=e.receiver;const n=e.type;const a=u.datas;delete a.history;delete a.search;delete a.images;delete a.shapes;const i={p:{sheetname:u.sheet.data.name,actrow:u.sheet.data.selector.ri,actcol:u.sheet.data.selector.ci,datas:u.getUpdateDatas()},uid:uniqueid,file:y,folderName:w,outputType:n,password:g,locale:o.Locale};const s=k(JSON.stringify(i));const l=await fetch(`${b}EditorApi/Download`,{method:"POST",headers:{"Content-Type":"application/octet-stream","Content-Encoding":"gzip"},body:s});if(!l.ok){throw new Error("Failed to send email, please try again")}const r=await l.json();const c=new FormData;c.append("appName",o.AppName);c.append("email",t);c.append("url",r.DownloadFileLink);c.append("title",`Aspose.Cells.Editor - ${r.FileName}`);const d=await fetch(`/cells/editor/Report/SendEmail`,{method:"POST",crossDomain:true,withCredentials:true,body:c});const p=await d.json();if(!d.ok){throw new Error("Failed to send email,please try again")}return p.message}function D(e,t){const o=document.createElement("a");let n=e;if(typeof e=="string"){o.target="_blank"}else{n=window.URL.createObjectURL(e)}o.href=n;o.download=t;document.body.appendChild(o);o.click();document.body.removeChild(o);if(typeof e!="string"){window.URL.revokeObjectURL(n)}}function k(e){const t=pako.gzip(e);return new Blob([t])}function A(e){const t=document.createElement("textarea");t.value=e;t.style.position="fixed";t.style.top="0";t.style.left="0";document.body.appendChild(t);t.focus();t.select();document.execCommand("copy");document.body.removeChild(t)}function U(e){if(!navigator.clipboard){A(e);return}navigator.clipboard.writeText(e).then()}function F(e){const t=new RegExp(`(^|&)${e}=([^&]*)(&|$)`);const o=window.location.search.substring(1).match(t);if(o!=null)return decodeURI(o[2]);return""}function T(){if(window.parent&&window.parent.closeIframe){window.parent.closeIframe()}else{window.location.href=n}}function I(){const e=document.createElement("div");e.id="aspose_mask_bg";e.style.position="absolute";e.style.top="0px";e.style.left="0px";e.style.width="100%";e.style.height="100%";e.style.backgroundColor="#777";e.style.opacity="0.6";e.style.zIndex="10001";document.body.appendChild(e);const t=document.createElement("div");t.style.position="absolute";t.style.top="33%";t.style.left="40%";t.style.backgroundColor="white";t.style.border="#336699 1px solid";t.style.textAlign="center";t.style.fontSize="medium";t.style.padding="1.5em 4em 1.5em 4em";t.innerText="Downloading, please wait...";e.appendChild(t)}function N(){const e=document.getElementById("aspose_mask_bg");if(e!=null)e.parentNode.removeChild(e)}function O(){gapi.load("picker",J)}function J(){c=true}function P(){l=google.accounts.oauth2.initTokenClient({client_id:s,scope:i,callback:""});d=true}function R(t,o){l.callback=async e=>{if(e.error!==undefined){throw e}r=e.access_token;fetch(t).then(e=>e.blob()).then(e=>{const t=new FormData;t.append("metadata",new Blob([JSON.stringify({name:o})],{type:"application/json"}));t.append("file",e);fetch("https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart",{method:"POST",headers:new Headers({Authorization:`Bearer ${r}`}),body:t}).then(e=>e.json(),e=>{console.error(e);alert(`Failed to save to Google Drive`)}).then(()=>{alert(`Successfully saved to Google Drive`)})})};if(r===null){l.requestAccessToken({prompt:"consent"})}else{l.requestAccessToken({prompt:""})}}function j(e,t){const o={success:function(){alert(`Successfully saved to Dropbox`)},progress:function(){},cancel:function(){},error:function(){alert(`Failed to save to Dropbox`)}};Dropbox.save(e,t,o)}function _(e,t){fetch(e).then(e=>e.blob(),e=>{console.error(e);alert("Download failed, please try again")}).then(e=>D(e,t))}function L(e){return e==null||e===""||e==="null"||e==="undefined"}});